---
import { ChaptersCon } from "./ChaptersCon/ChaptersCon";
import { CharactersCon } from "./CharactersCon/CharactersCon";
import { MangaInfoCon } from "./MangaInfoCon/MangaInfoCon";
import { MangaSideInfoCon } from "./MangaSideInfoCon/MangaSideInfoCon";
import { SimilarsCon } from "./SimilarsCon/SimilarsCon";
import { checkIfBookMarked } from "../../../services/MangaRealm.api/api.ts"

import '../../../styles/pages/mangaRead.scss';

const { manga, similars } = Astro.props
const { title, malData } = manga;
const { slug } = Astro.params as { slug: string };

const cookies = Astro.cookies
const auth_token = cookies.get("auth_token")?.value
const rawUserData = cookies.get("user_data")?.value || "{}"
const { email } = JSON.parse(rawUserData)
const { isIn: isBookMarked, token } =  await checkIfBookMarked({ slug, email, auth_token })

const url = Astro.url
---

<div class="manga-details-con px-3">
	<div class="manga-outer-info-con">
		<MangaInfoCon client:load isBookMarked={isBookMarked} token={token} url={url.toString()} manga={manga} />
		<MangaSideInfoCon manga={manga} />
	</div>
	<div class="manga-chapters-similars-con">
		<ChaptersCon client:load manga={manga} />
		<SimilarsCon mangaSlug={slug} similars={similars} />
	</div>
	{malData && malData.characters && (
		<CharactersCon title={title} characters={malData.characters} />
	)}
</div>

<script define:vars={{ url: url }}>
	const shareBtn = document.querySelector(".share-btn")

	shareBtn?.addEventListener("click", () => {
		navigator.clipboard.writeText(url);
		ShowAlert("Copied to clipboard") // TODO: this is should be a custom alert box
	})
	const ShowAlert = (message) => {
		const alertbox = document.querySelector(".alertbox")
		const msgEle = document.querySelector(".alertbox .msg")

		msgEle.textContent = message
		alertbox.style.display = "flex"
		const fiveSecs = 5000
		setTimeout(() => {
			msgEle.textContent = ""
			alertbox.style.display = "none"
		}, fiveSecs)
	}
</script>