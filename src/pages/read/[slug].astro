---
import MainLayout from '../../layouts/main.astro';
import { getMangas, getCachedManga } from '../../services/Manganato/manganato';
import { getSettings, getValues, getDisabledAnimes } from "../../services/MangaRealm.api/admin/handlers.ts"
import type { genre } from '../../services/Manganato/manganatoTypes';
import { getAlertRedirectUrl } from '../../utilities/misc.ts';
import Comments  from '../../components/Widgets/Comments/Comments.astro'
import MangaDetails  from '../../components/Widgets/MangaDetails/MangaDetails.astro'

const settings = await getSettings()
const disableManga = settings.manga.value

if (disableManga == true) {
  return Astro.redirect("/") 
} 

const { slug } = Astro.params;
const url = Astro.url

const manga = await getCachedManga(slug)
let similars: any = [] 
if (manga) {
	const { genres } = manga
	const genre: genre = genres[Math.floor(Math.random() * genres.length)];
	const response = await getMangas(`/filter?genre=${genre.slug.replace("/", "")}`)
	similars = response.mangas
}

if (!slug || !manga) {
  const base = Astro.url.origin
  const message = "Manga Not found";
  const description = "Hello! This Manga is not on our services!.";
  const redirectUrl = getAlertRedirectUrl(base, message, description)

	return Astro.redirect(redirectUrl)
}

const diabledAnimes = await getDisabledAnimes() //! :( forgot to change the disableAnimes to disableMangas in the admin panel so i am keeping

if (diabledAnimes[slug] == true) {
  const base = Astro.url.origin
  const message = "Site in under maintanence";
  const description = "Hello! This Manga is currently been disabled on our services!, we may enable it on a later date.";
  const redirectUrl = getAlertRedirectUrl(base, message, description)

  return Astro.redirect(redirectUrl) 
} 


const values = await getValues()
const siteName =  values.inputs.site_name.value
---

<MainLayout title={ `Reading ${manga.title} on ${siteName}` } page="read" >	
	<MangaDetails manga={manga} similars={similars} />
	<Comments isOnClick={true} PAGE_URL={url} PAGE_IDENTIFIER={slug}/>
</MainLayout>